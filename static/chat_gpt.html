<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 비서 상담 정리봇</title>
    <link rel="icon" href="data:,">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Pretendard', sans-serif;
            background: #f7f7f8;
            background-image: 
                radial-gradient(circle, #d1d5db 0.5px, transparent 0.5px);
            background-size: 24px 24px;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .chat-container {
            width: 100%;
            max-width: 1000px;
            height: 92vh;
            background: #ffffff;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 18px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .header-title {
            flex: 1;
            text-align: center;
            font-size: 18px;
            font-weight: 500;
            letter-spacing: -0.3px;
            padding-right: 200px;
        }

        .header-actions {
            position: absolute;
            right: 29px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-phone {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 400;
            opacity: 0.9;
            white-space: nowrap;
        }

        .phone-button {
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .phone-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .header-icon-button {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0.9;
        }

        .header-icon-button:hover {
            background: rgba(255, 255, 255, 0.25);
            opacity: 1;
            transform: translateY(-1px);
        }

        .header-icon-button svg {
            width: 18px;
            height: 18px;
            fill: white;
        }

        /* 디버그 패널 */
        .debug-panel {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 400px;
            max-height: 50vh;
            background: #1f2937;
            color: #e5e7eb;
            border-top-left-radius: 12px;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: none;
            flex-direction: column;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .debug-panel.visible {
            display: flex;
        }

        .debug-panel-header {
            padding: 12px 16px;
            background: #111827;
            border-top-left-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            user-select: none;
        }

        .debug-panel-title {
            font-weight: 600;
            color: #f9fafb;
            font-size: 13px;
        }

        .debug-panel-controls {
            display: flex;
            gap: 8px;
        }

        .debug-panel-btn {
            background: #374151;
            border: none;
            color: #e5e7eb;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: background 0.2s;
        }

        .debug-panel-btn:hover {
            background: #4b5563;
        }

        .debug-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .debug-log-entry {
            padding: 8px;
            border-radius: 4px;
            border-left: 3px solid #6b7280;
            background: #111827;
            word-break: break-word;
            white-space: pre-wrap;
        }

        .debug-log-entry.log {
            border-left-color: #3b82f6;
        }

        .debug-log-entry.info {
            border-left-color: #10b981;
        }

        .debug-log-entry.warn {
            border-left-color: #f59e0b;
        }

        .debug-log-entry.error {
            border-left-color: #ef4444;
        }

        .debug-log-time {
            color: #9ca3af;
            font-size: 10px;
            margin-bottom: 4px;
        }

        .debug-log-message {
            color: #e5e7eb;
        }

        .debug-log-data {
            margin-top: 4px;
            padding: 6px;
            background: #030712;
            border-radius: 4px;
            color: #9ca3af;
            font-size: 11px;
            max-height: 200px;
            overflow-y: auto;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: #ffffff;
        }

        /* 시스템 안내 카드 */
        .system-notice-card {
            background: #f6f7f9;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            font-size: 13px;
            color: #6b7280;
            line-height: 1.6;
        }

        .system-notice-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
        }

        .system-notice-icon {
            font-size: 16px;
            margin-right: 8px;
        }

        .system-notice-title {
            flex: 1;
            font-weight: 500;
            color: #374151;
        }

        .system-notice-toggle {
            font-size: 12px;
            color: #9ca3af;
            transition: transform 0.2s;
        }

        .system-notice-card.collapsed .system-notice-toggle {
            transform: rotate(-90deg);
        }

        .system-notice-content {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e5e7eb;
            display: block;
        }

        .system-notice-card.collapsed .system-notice-content {
            display: none;
        }

        .status-indicator {
            padding: 10px 14px;
            background: #f9fafb;
            border-radius: 10px;
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid #e5e7eb;
        }

        .status-dot {
            width: 9px;
            height: 9px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        .status-dot.disconnected {
            background: #ef4444;
            animation: none;
        }

        .message {
            margin-bottom: 24px;
            display: flex;
            align-items: flex-start;
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.bot {
            justify-content: flex-start;
        }

        .message-content {
            max-width: 80%;
            padding: 14px 18px;
            border-radius: 20px;
            word-wrap: break-word;
            white-space: pre-wrap;
            line-height: 1.7;
            font-size: 15px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 6px;
        }

        .message.bot .message-content {
            background: #f2f4f7;
            color: #1f2937;
            border-bottom-left-radius: 6px;
            border: 1px solid #e5e7eb;
        }

        /* 버튼 그룹 (유형 선택용) */
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 12px;
        }

        .option-button {
            background: #ffffff;
            border: 1.5px solid #e5e7eb;
            border-radius: 14px;
            padding: 14px 18px;
            font-size: 15px;
            color: #1f2937;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            font-weight: 400;
        }

        .option-button:hover {
            border-color: #667eea;
            background: #f8f9ff;
            transform: translateX(2px);
        }

        .option-button:active {
            transform: translateX(0);
        }

        .step-label {
            font-size: 13px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
            display: block;
        }

        .chat-input-container {
            padding: 20px 24px;
            background: #ffffff;
            border-top: 1px solid #e5e7eb;
            flex-shrink: 0;
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: center;
            max-width: 100%;
        }

        .file-attach-button {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: #f3f4f6;
            border: 1.5px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .file-attach-button:hover {
            background: #e5e7eb;
            border-color: #667eea;
        }

        .file-attach-button:active {
            transform: scale(0.95);
        }

        .file-attach-button svg {
            width: 20px;
            height: 20px;
            fill: #6b7280;
            transition: fill 0.2s;
        }

        .file-attach-button:hover svg {
            fill: #667eea;
        }

        .file-attach-button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .chat-input {
            flex: 1;
            padding: 14px 20px;
            border: 1.5px solid #d1d5db;
            border-radius: 26px;
            font-size: 15px;
            outline: none;
            transition: all 0.2s ease;
            background: #ffffff;
            color: #1f2937;
            font-family: inherit;
        }

        .chat-input::placeholder {
            color: #9ca3af;
        }

        .chat-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.08);
        }

        .send-button {
            padding: 14px 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 26px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);
            min-width: 80px;
        }

        .send-button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .send-button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(102, 126, 234, 0.2);
        }

        .send-button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2.5px solid #e5e7eb;
            border-top: 2.5px solid #667eea;
            border-radius: 50%;
            animation: spin 0.9s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fef2f2;
            color: #dc2626;
            padding: 14px 18px;
            border-radius: 12px;
            margin-bottom: 16px;
            border-left: 3px solid #dc2626;
            font-size: 14px;
            line-height: 1.6;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        /* 스크롤바 스타일 */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        .hidden {
            display: none !important;
        }

        /* 모달 스타일 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e5e7eb;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: #f3f4f6;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #e5e7eb;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
        }

        .form-input,
        .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1.5px solid #d1d5db;
            border-radius: 12px;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.2s;
            background: white;
        }

        .form-textarea {
            resize: vertical;
            min-height: 120px;
        }

        .form-input:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .form-file-input {
            display: none;
        }

        .file-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #f9fafb;
        }

        .file-upload-area:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .file-upload-area.dragover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .file-list {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: #f9fafb;
            border-radius: 8px;
            font-size: 14px;
        }

        .file-item-name {
            flex: 1;
            color: #374151;
        }

        .file-item-remove {
            color: #ef4444;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .file-item-remove:hover {
            background: #fee2e2;
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        /* 반응형 처리 */
        @media (max-width: 768px) {
            .header-title {
                padding-right: 200px;
                font-size: 16px;
            }

            .header-actions {
                right: 19px;
                gap: 8px;
            }

            .header-icon-button {
                width: 32px;
                height: 32px;
            }

            .header-icon-button svg {
                width: 16px;
                height: 16px;
            }

            .header-phone {
                font-size: 12px;
                gap: 6px;
            }

            .phone-button {
                padding: 5px 10px;
                font-size: 11px;
            }

            .modal {
                max-width: 90%;
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            .header-title {
                padding-right: 0;
                font-size: 15px;
            }

            .header-actions {
                position: static;
                transform: none;
                margin-left: auto;
                gap: 6px;
            }

            .header-icon-button {
                width: 28px;
                height: 28px;
            }

            .header-icon-button svg {
                width: 14px;
                height: 14px;
            }

            .header-phone {
                font-size: 11px;
            }

            .phone-button {
                padding: 4px 8px;
                font-size: 10px;
            }

            .chat-header {
                flex-wrap: wrap;
                padding: 14px 16px;
            }

            .modal {
                max-width: 95%;
                padding: 16px;
            }

            .modal-title {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="header-title">
                AI 비서 상담 정리봇
            </div>
            <div class="header-actions">
                <div class="header-phone">
                    <span>☎ 060-604-1000</span>
                    <span class="phone-button">상담 연결</span>
                </div>
                <div class="header-icon-button" onclick="openFileUpload()" title="파일 첨부" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                </div>
                <div class="header-icon-button" onclick="openDirectWrite()" title="직접 상담글 쓰기">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                </div>
                <div class="header-icon-button" onclick="openBugReport()" title="버그 신고">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                        <line x1="12" y1="9" x2="12" y2="13"></line>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                </div>
                <div class="header-icon-button" onclick="toggleDebugPanel()" title="디버그 로그">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                    </svg>
                </div>

            </div>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <!-- 시스템 안내 카드 -->
            <div class="system-notice-card" id="systemNoticeCard">
                <div class="system-notice-header" onclick="toggleNotice()">
                    <div style="display: flex; align-items: center;">
                        <span class="system-notice-icon">ⓘ</span>
                        <span class="system-notice-title">안내</span>
                    </div>
                    <span class="system-notice-toggle">▼</span>
                </div>
                <div class="system-notice-content">
                    이 서비스는 법률 자문이 아니라,<br>
                    상담을 위해 사실관계를 정리하는 AI 도우미입니다.<br>
                    정확한 판단은 변호사 상담이 필요합니다.
                </div>
            </div>

            <div class="status-indicator hidden" id="statusIndicator">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">연결 중...</span>
            </div>
        </div>

        <div class="chat-input-container">
            <div class="input-wrapper">
                <button class="file-attach-button" id="fileAttachButton" onclick="openFileUpload()" title="파일 첨부" disabled>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                </button>
                <input 
                    type="text" 
                    class="chat-input" 
                    id="chatInput" 
                    placeholder="예: 2024년 10월, 중고거래로 30만 원을 보냈는데 물건을 받지 못했고 연락이 끊겼습니다." 
                    disabled
                />
                <button class="send-button" id="sendButton" disabled>전송</button>
            </div>
        </div>
    </div>

    <!-- 버그 신고 모달 -->
    <div class="modal-overlay" id="bugReportModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">버그 신고</h3>
                <button class="modal-close" onclick="closeModal('bugReportModal')">✕</button>
            </div>
            <div class="modal-body">
                <form id="bugReportForm">
                    <div class="form-group">
                        <label class="form-label">발생한 문제를 설명해주세요</label>
                        <textarea class="form-textarea" id="bugDescription" placeholder="어떤 문제가 발생했는지 자세히 설명해주세요." required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">재현 방법 (선택사항)</label>
                        <textarea class="form-textarea" id="bugSteps" placeholder="문제를 재현하는 방법을 단계별로 적어주세요."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">기기 정보 (선택사항)</label>
                        <input type="text" class="form-input" id="bugDevice" placeholder="예: Chrome 브라우저, Windows 10">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('bugReportModal')">취소</button>
                <button class="btn btn-primary" onclick="submitBugReport()">신고하기</button>
            </div>
        </div>
    </div>

    <!-- 직접 글쓰기 모달 -->
    <div class="modal-overlay" id="directWriteModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">직접 상담글 쓰기</h3>
                <button class="modal-close" onclick="closeModal('directWriteModal')">✕</button>
            </div>
            <div class="modal-body">
                <form id="directWriteForm">
                    <div class="form-group">
                        <label class="form-label">상담 내용</label>
                        <textarea class="form-textarea" id="directWriteContent" placeholder="상담하고 싶은 내용을 자세히 작성해주세요.&#10;&#10;예:&#10;- 언제, 어디서 발생했는지&#10;- 관련된 사람이나 기관&#10;- 현재 상황과 원하는 결과" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('directWriteModal')">취소</button>
                <button class="btn btn-primary" onclick="submitDirectWrite()">작성 완료</button>
            </div>
        </div>
    </div>

    <!-- 파일 첨부 모달 -->
    <div class="modal-overlay" id="fileUploadModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">파일 첨부</h3>
                <button class="modal-close" onclick="closeModal('fileUploadModal')">✕</button>
            </div>
            <div class="modal-body">
                <form id="fileUploadForm">
                    <div class="form-group">
                        <label class="form-label">파일 선택</label>
                        <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('fileInput').click()">
                            <div>
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="2" style="margin: 0 auto 12px;">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                                <p style="color: #6b7280; margin: 0;">클릭하거나 파일을 드래그하여 업로드</p>
                                <p style="color: #9ca3af; font-size: 12px; margin: 8px 0 0 0;">PDF, 이미지, 문서 파일 (최대 10MB)</p>
                            </div>
                        </div>
                        <input type="file" id="fileInput" class="form-file-input" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.txt">
                        <div class="file-list" id="fileList"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">파일 설명 (선택사항)</label>
                        <textarea class="form-textarea" id="fileDescription" placeholder="첨부한 파일에 대한 간단한 설명을 적어주세요."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('fileUploadModal')">취소</button>
                <button class="btn btn-primary" onclick="submitFileUpload()">첨부 완료</button>
            </div>
        </div>
    </div>

    <script>
        // 디버그 로깅 시스템 (먼저 정의)
        const DEBUG_ENABLED = true; // 항상 활성화
        const MAX_DEBUG_LOGS = 100; // 최대 로그 개수

        function debugLog(level, message, data = null) {
            const timestamp = new Date().toLocaleTimeString('ko-KR');
            const logEntry = {
                level,
                timestamp,
                message,
                data
            };

            // 콘솔 로그
            const consoleMethod = {
                'log': console.log,
                'info': console.info,
                'warn': console.warn,
                'error': console.error
            }[level] || console.log;

            if (data) {
                consoleMethod(`[${timestamp}] ${message}`, data);
            } else {
                consoleMethod(`[${timestamp}] ${message}`);
            }

            // HTML 디버그 패널에 추가
            if (DEBUG_ENABLED) {
                addDebugLogToPanel(logEntry);
            }
        }

        function addDebugLogToPanel(logEntry) {
            const panel = document.getElementById('debugPanel');
            const content = document.getElementById('debugLogContent');
            
            if (!panel || !content) return;

            // 최대 로그 개수 제한
            const logs = content.children;
            if (logs.length >= MAX_DEBUG_LOGS) {
                content.removeChild(logs[0]);
            }

            const logDiv = document.createElement('div');
            logDiv.className = `debug-log-entry ${logEntry.level}`;
            
            const timeDiv = document.createElement('div');
            timeDiv.className = 'debug-log-time';
            timeDiv.textContent = logEntry.timestamp;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'debug-log-message';
            messageDiv.textContent = logEntry.message;
            
            logDiv.appendChild(timeDiv);
            logDiv.appendChild(messageDiv);

            if (logEntry.data) {
                const dataDiv = document.createElement('div');
                dataDiv.className = 'debug-log-data';
                dataDiv.textContent = JSON.stringify(logEntry.data, null, 2);
                logDiv.appendChild(dataDiv);
            }

            content.appendChild(logDiv);
            
            // 자동 스크롤
            content.scrollTop = content.scrollHeight;
        }

        function toggleDebugPanel() {
            const panel = document.getElementById('debugPanel');
            if (panel) {
                panel.classList.toggle('visible');
            }
        }

        function clearDebugLogs() {
            const content = document.getElementById('debugLogContent');
            if (content) {
                content.innerHTML = '';
                debugLog('info', '디버그 로그가 지워졌습니다.');
            }
        }

        // 로깅 헬퍼 함수들
        function logInfo(message, data = null) {
            debugLog('info', message, data);
        }

        function logWarn(message, data = null) {
            debugLog('warn', message, data);
        }

        function logError(message, data = null) {
            debugLog('error', message, data);
        }

        function logApiRequest(method, url, body = null) {
            logInfo(`API 요청: ${method} ${url}`, { body });
        }

        function logApiResponse(method, url, response, data = null) {
            logInfo(`API 응답: ${method} ${url}`, { 
                status: response.status, 
                statusText: response.statusText,
                data 
            });
        }

        function logStateTransition(fromState, toState, sessionId) {
            logInfo(`State 전이: ${fromState} → ${toState}`, { sessionId });
        }

        // 파일 프로토콜 체크
        if (window.location.protocol === 'file:') {
            document.body.innerHTML = `
                <div style="display: flex; justify-content: center; align-items: center; height: 100vh; background: #f7f7f8; flex-direction: column; padding: 20px; text-align: center;">
                    <h2 style="color: #dc2626; margin-bottom: 20px;">⚠️ 서버를 통해 접근해주세요</h2>
                    <p style="color: #6b7280; margin-bottom: 30px; font-size: 16px;">
                        이 파일은 직접 열 수 없습니다.<br>
                        FastAPI 서버를 실행한 후 다음 URL로 접근해주세요:
                    </p>
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
                        <code style="font-size: 18px; color: #667eea;">http://localhost:8000/static/chat_gpt.html</code>
                    </div>
                    <div style="background: #fef3c7; padding: 15px; border-radius: 12px; border-left: 4px solid #f59e0b; max-width: 600px;">
                        <p style="margin: 0; color: #92400e;">
                            <strong>서버 실행 방법:</strong><br>
                            1. 터미널에서 프로젝트 디렉토리로 이동<br>
                            2. <code>uvicorn src.api.main:app --reload --host 0.0.0.0 --port 8000</code> 실행<br>
                            3. 위 URL로 접근
                        </p>
                    </div>
                </div>
            `;
            throw new Error('File protocol not supported');
        }
        
        const API_BASE_URL = window.location.origin;
        logInfo('API Base URL 설정', { baseUrl: API_BASE_URL });
        
        // API 키 설정 (localStorage에서 가져오거나 입력받기)
        let API_KEY = localStorage.getItem('api_key');
        if (!API_KEY) {
            API_KEY = prompt('API 키를 입력하세요 (한 번만 입력하면 저장됩니다):');
            if (API_KEY) {
                localStorage.setItem('api_key', API_KEY);
                logInfo('API 키 저장됨');
            } else {
                logWarn('API 키가 입력되지 않았습니다');
            }
        } else {
            logInfo('저장된 API 키 사용');
        }
        let sessionId = null;
        let isProcessing = false;
        let currentStep = 'greeting';
        let lastBotMessage = ''; // 마지막 봇 메시지 저장 (중복 방지)

        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');

        // API 호출 헤더 생성
        function getHeaders() {
            const headers = {
                'Content-Type': 'application/json',
            };
            if (API_KEY) {
                headers['Authorization'] = `Bearer ${API_KEY}`;
            }
            return headers;
        }

        // API 연결 테스트 함수
        async function testApiConnection() {
            try {
                logInfo('API 연결 테스트 시작', { baseUrl: API_BASE_URL });
                // 간단한 GET 요청으로 연결 테스트 (루트 경로 또는 health check)
                const testResponse = await fetch(`${API_BASE_URL}/`, {
                    method: 'GET',
                    headers: getHeaders()
                });
                logInfo('API 연결 테스트 결과', { 
                    status: testResponse.status, 
                    ok: testResponse.ok 
                });
                // 200-299 또는 404(엔드포인트 없어도 서버는 동작 중)면 연결 성공
                return testResponse.ok || testResponse.status === 404;
            } catch (error) {
                logError('API 연결 테스트 실패', { 
                    error: error.message,
                    baseUrl: API_BASE_URL,
                    errorName: error.name
                });
                return false;
            }
        }

        // 시스템 안내 카드 접기/펼치기
        function toggleNotice() {
            const card = document.getElementById('systemNoticeCard');
            card.classList.toggle('collapsed');
        }

        // 세션 시작
        async function startSession() {
            try {
                logInfo('세션 시작 시도', { apiBaseUrl: API_BASE_URL });
                statusIndicator.classList.remove('hidden');
                updateStatus('세션 시작 중...', false);
                
                if (!API_KEY) {
                    throw new Error('API 키가 설정되지 않았습니다. 페이지를 새로고침하여 API 키를 입력해주세요.');
                }
                
                // API 연결 테스트 (선택적 - 실패해도 계속 진행)
                try {
                    const isConnected = await testApiConnection();
                    if (!isConnected) {
                        logWarn('API 연결 테스트 실패, 계속 진행', { apiBaseUrl: API_BASE_URL });
                    }
                } catch (testError) {
                    logWarn('API 연결 테스트 중 오류, 계속 진행', { error: testError.message });
                    // 연결 테스트 실패해도 실제 API 호출은 시도
                }
                
                // 기존 세션 복원 비활성화 - 항상 새 세션으로 시작
                // 저장된 세션 ID가 있으면 삭제하여 새 세션 시작
                const savedSessionId = localStorage.getItem('current_session_id');
                if (savedSessionId) {
                    logInfo('저장된 세션 ID 삭제 (새 세션 시작)', { sessionId: savedSessionId });
                    localStorage.removeItem('current_session_id');
                }
                
                const startRequestBody = {
                    channel: 'web',
                    user_id: `user_${Date.now()}`,
                    device: 'desktop'
                };
                logApiRequest('POST', `${API_BASE_URL}/chat/start`, startRequestBody);
                
                const response = await fetch(`${API_BASE_URL}/chat/start`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify(startRequestBody)
                });

                logApiResponse('POST', `${API_BASE_URL}/chat/start`, response);

                if (!response.ok) {
                    if (response.status === 401) {
                        // API 키 오류
                        localStorage.removeItem('api_key');
                        throw new Error('API 키가 유효하지 않습니다. 페이지를 새로고침하여 다시 입력해주세요.');
                    }
                    const errorData = await response.json().catch(() => ({ error: { message: `HTTP ${response.status}: ${response.statusText}` } }));
                    logError('세션 시작 API 오류', { 
                        status: response.status, 
                        statusText: response.statusText,
                        error: errorData,
                        apiBaseUrl: API_BASE_URL
                    });
                    throw new Error(errorData.error?.message || errorData.error?.detail || `HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                logInfo('세션 시작 응답', { 
                    success: data.success,
                    sessionId: data.data?.session_id,
                    state: data.data?.current_state || data.data?.state
                });
                
                if (data.success && data.data) {
                    sessionId = data.data.session_id;
                    // 세션 ID 저장하지 않음 (새로고침 시 항상 새 세션 시작)
                    lastBotMessage = ''; // 새 세션 시작 시 초기화
                    
                    // AI 첫 메시지 (간단한 인사)
                    setTimeout(() => {
                        addMessage('bot', '안녕하세요.\n상담 전에 상황을 정리해드릴게요.\n\n아래 질문에 편하게 답해주시면,\n변호사 상담에 필요한 핵심만 정리해드립니다.');
                        
                        // STEP 1 메시지
                        setTimeout(() => {
                            addStepMessage('STEP 1. 어떤 일이 있었나요?', 
                                '언제 / 누구와 / 어떤 일이 있었는지\n3~5줄로 편하게 적어주세요.\n(금액, 증거가 있다면 함께 적어주시면 좋아요)');
                            currentStep = 'situation';
                        }, 500);
                    }, 300);
                    
                    chatInput.disabled = false;
                    sendButton.disabled = false;
                    document.getElementById('fileAttachButton').disabled = false;
                    updateStatus('연결됨', true);
                    statusIndicator.classList.add('hidden');
                } else {
                    throw new Error(data.error?.message || '세션 시작 실패');
                }
            } catch (error) {
                logError('세션 시작 오류', { 
                    error: error.message, 
                    stack: error.stack,
                    apiBaseUrl: API_BASE_URL,
                    hasApiKey: !!API_KEY,
                    errorType: error.constructor.name,
                    errorName: error.name
                });
                
                // 네트워크 오류인 경우 명확한 메시지 표시
                let errorMessage = error.message;
                if (error.message.includes('Failed to fetch') || 
                    error.message.includes('NetworkError') || 
                    error.message.includes('Network request failed') ||
                    error.name === 'TypeError' ||
                    error.message.includes('CORS')) {
                    errorMessage = `API 서버에 연결할 수 없습니다.\n\n서버 주소: ${API_BASE_URL}\n\n서버가 실행 중인지 확인해주세요.\n\n터미널에서 다음 명령어로 서버를 실행하세요:\nuvicorn src.api.main:app --reload --host 0.0.0.0 --port 8000`;
                }
                
                addErrorMessage(`세션 시작 실패: ${errorMessage}`);
                updateStatus('연결 실패', false);
            }
        }

        // STEP 메시지 추가
        function addStepMessage(stepLabel, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = `<span class="step-label">${stepLabel}</span>${content}`;
            
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 버튼 그룹 추가 (유형 선택용)
        function addButtonGroup(stepLabel, buttons) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            const label = document.createElement('span');
            label.className = 'step-label';
            label.textContent = stepLabel;
            contentDiv.appendChild(label);
            
            const buttonGroup = document.createElement('div');
            buttonGroup.className = 'button-group';
            
            buttons.forEach(button => {
                const btn = document.createElement('button');
                btn.className = 'option-button';
                btn.textContent = button.text;
                btn.onclick = () => {
                    handleButtonClick(button.value, button.text);
                };
                buttonGroup.appendChild(btn);
            });
            
            contentDiv.appendChild(buttonGroup);
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 버튼 클릭 처리
        function handleButtonClick(value, text) {
            // 사용자 선택 표시
            addMessage('user', text);
            
            // 서버에 전송
            sendButtonClick(value, text);
        }

        // 메시지 전송
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message || isProcessing || !sessionId) return;

            addMessage('user', message);
            chatInput.value = '';
            chatInput.disabled = true;
            sendButton.disabled = true;
            document.getElementById('fileAttachButton').disabled = true;
            isProcessing = true;
            
            const loadingMessage = addMessage('bot', '처리 중...', true);

            try {
                const response = await fetch(`${API_BASE_URL}/chat/message`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        session_id: sessionId,
                        user_message: message
                    })
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        // API 키 오류
                        localStorage.removeItem('api_key');
                        throw new Error('API 키가 유효하지 않습니다. 페이지를 새로고침하여 다시 입력해주세요.');
                    }
                    const errorData = await response.json().catch(() => ({ error: { message: `HTTP ${response.status}: ${response.statusText}` } }));
                    throw new Error(errorData.error?.message || errorData.error?.detail || `HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                loadingMessage.remove();

                if (data.success && data.data) {
                    handleBotResponse(data.data);
                } else {
                    throw new Error(data.error?.message || '메시지 전송 실패');
                }
            } catch (error) {
                logError('메시지 전송 오류', { error: error.message, stack: error.stack });
                loadingMessage.remove();
                addErrorMessage(`메시지 전송 실패: ${error.message}`);
            } finally {
                chatInput.disabled = false;
                sendButton.disabled = false;
                document.getElementById('fileAttachButton').disabled = false;
                isProcessing = false;
                chatInput.focus();
            }
        }

        // 버튼 클릭 전송
        async function sendButtonClick(value, text) {
            if (isProcessing || !sessionId) return;

            chatInput.disabled = true;
            sendButton.disabled = true;
            document.getElementById('fileAttachButton').disabled = true;
            isProcessing = true;
            
            const loadingMessage = addMessage('bot', '처리 중...', true);

            try {
                const requestBody = {
                    session_id: sessionId,
                    user_message: text
                };
                logApiRequest('POST', `${API_BASE_URL}/chat/message`, requestBody);
                
                const response = await fetch(`${API_BASE_URL}/chat/message`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        // API 키 오류
                        localStorage.removeItem('api_key');
                        throw new Error('API 키가 유효하지 않습니다. 페이지를 새로고침하여 다시 입력해주세요.');
                    }
                    const errorData = await response.json().catch(() => ({ error: { message: `HTTP ${response.status}: ${response.statusText}` } }));
                    throw new Error(errorData.error?.message || errorData.error?.detail || `HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                loadingMessage.remove();

                if (data.success && data.data) {
                    handleBotResponse(data.data);
                } else {
                    throw new Error(data.error?.message || '메시지 전송 실패');
                }
            } catch (error) {
                logError('메시지 전송 오류', { error: error.message, stack: error.stack });
                loadingMessage.remove();
                addErrorMessage(`메시지 전송 실패: ${error.message}`);
            } finally {
                chatInput.disabled = false;
                sendButton.disabled = false;
                document.getElementById('fileAttachButton').disabled = false;
                isProcessing = false;
                chatInput.focus();
            }
        }

        // 봇 응답 처리
        function handleBotResponse(data) {
            // bot_message가 없거나 빈 문자열이면 스킵 (기본 메시지 표시하지 않음)
            const botMessage = data.bot_message;
            
            // 상태에 따라 다른 처리
            const state = data.current_state || data.state;
            const previousState = currentStep;
            
            logInfo('봇 응답 수신', { 
                state, 
                previousState,
                botMessage: botMessage ? botMessage.substring(0, 100) : '(메시지 없음)',
                sessionId,
                completionRate: data.completion_rate,
                expectedInput: data.expected_input,
                hasBotMessage: !!botMessage
            });
            
            // 빈 메시지나 안내 메시지가 반복되는 경우 스킵
            if (!botMessage || botMessage.trim() === '') {
                logWarn('빈 봇 메시지 수신, 스킵', { state, previousState });
                // 상태 전이만 업데이트 (메시지 없이)
                if (previousState !== state) {
                    logStateTransition(previousState, state, sessionId);
                    currentStep = state.toLowerCase();
                }
                return;
            }
            
            // 중복 메시지 체크 제거 - 노드에서 처리하도록 변경
            // HTML에서는 모든 메시지를 표시하고, 노드에서 사용자 입력 처리 여부를 확인하도록 함
            
            // State 전이 로깅
            if (previousState !== state) {
                logStateTransition(previousState, state, sessionId);
            }
            
            // 마지막 메시지 업데이트 (로깅용으로만 사용)
            lastBotMessage = botMessage.trim();
            
            // 세션 ID를 localStorage에 저장하지 않음 (새로고침 시 항상 새 세션 시작)
            // if (sessionId) {
            //     localStorage.setItem('current_session_id', sessionId);
            // }
            
            if (state === 'CASE_CLASSIFICATION' || state === 'case_classification') {
                // 유형 선택 버튼 표시
                addButtonGroup('🧭 STEP 2. 어떤 유형에 가까운가요?', [
                    { text: '💰 돈·계약·부동산', value: 'contract' },
                    { text: '🚨 사기·형사', value: 'criminal' },
                    { text: '👨‍👩‍👧 이혼·가족', value: 'family' },
                    { text: '🏛 행정처분', value: 'administrative' }
                ]);
                currentStep = 'classification';
            } else if (state === 'FACT_COLLECTION' || state === 'fact_collection') {
                // 사실 수집 단계
                addMessage('bot', botMessage);
                currentStep = 'fact_collection';
            } else if (state === 'RE_QUESTION' || state === 're_question') {
                // 재질문 단계
                addMessage('bot', botMessage);
                currentStep = 're_question';
            } else if (state === 'VALIDATION' || state === 'validation') {
                // 검증 단계
                addMessage('bot', botMessage);
                currentStep = 'validation';
            } else if (state === 'SUMMARY' || state === 'summary') {
                // 요약 단계
                addMessage('bot', botMessage);
                currentStep = 'summary';
            } else if (state === 'COMPLETED' || state === 'completed') {
                // 완료 단계
                addMessage('bot', botMessage);
                currentStep = 'completed';
                
                // 최종 요약 정보 가져오기
                loadFinalSummary(sessionId);
            } else {
                // 일반 메시지 표시
                addMessage('bot', botMessage);
            }
        }

        // 최종 요약 정보 로드
        async function loadFinalSummary(sessionId) {
            if (!sessionId) {
                logWarn('세션 ID가 없어 요약 정보를 가져올 수 없습니다');
                return;
            }
            
            try {
                logInfo('최종 요약 정보 로드 시작', { sessionId });
                const response = await fetch(`${API_BASE_URL}/chat/result?session_id=${sessionId}`, {
                    method: 'GET',
                    headers: getHeaders()
                });
                
                if (!response.ok) {
                    if (response.status === 404) {
                        logWarn('요약 정보가 아직 생성되지 않았습니다');
                        return;
                    }
                    const errorData = await response.json().catch(() => ({ error: { message: `HTTP ${response.status}` } }));
                    throw new Error(errorData.error?.message || `HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.data) {
                    displayFinalSummary(data.data);
                } else {
                    logWarn('요약 정보 조회 실패', data);
                }
            } catch (error) {
                logError('최종 요약 정보 로드 오류', { error: error.message, sessionId });
                // 오류가 있어도 사용자에게는 표시하지 않음 (이미 완료 메시지가 표시됨)
            }
        }
        
        // 최종 요약 정보 표시
        function displayFinalSummary(summaryData) {
            const summaryText = summaryData.case_summary_text || summaryData.summary_text || '';
            const structuredData = summaryData.structured_data || {};
            
            if (!summaryText && Object.keys(structuredData).length === 0) {
                logWarn('표시할 요약 정보가 없습니다');
                return;
            }
            
            // 요약 카드 생성
            const summaryCard = document.createElement('div');
            summaryCard.className = 'message bot';
            summaryCard.style.marginTop = '24px';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.style.background = '#f0f9ff';
            contentDiv.style.border = '2px solid #0ea5e9';
            contentDiv.style.borderRadius = '16px';
            contentDiv.style.padding = '24px';
            
            let summaryHTML = `
                <div style="margin-bottom: 16px;">
                    <h3 style="font-size: 18px; font-weight: 600; color: #0c4a6e; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 24px;">📋</span>
                        <span>상담 요약</span>
                    </h3>
                </div>
            `;
            
            // 구조화된 데이터가 있으면 구조화된 형태로 표시
            if (structuredData && Object.keys(structuredData).length > 0) {
                summaryHTML += '<div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 16px;">';
                
                // 사건 유형
                if (structuredData.사건_유형 || structuredData.case_type) {
                    summaryHTML += `
                        <div style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #e5e7eb;">
                            <div style="font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">사건 유형</div>
                            <div style="font-size: 16px; font-weight: 500; color: #1f2937;">${escapeHtml(structuredData.사건_유형 || structuredData.case_type || '-')}</div>
                        </div>
                    `;
                }
                
                // 핵심 사실관계
                if (structuredData.핵심_사실관계 || structuredData.facts) {
                    summaryHTML += `
                        <div style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #e5e7eb;">
                            <div style="font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">핵심 사실관계</div>
                            <div style="font-size: 15px; color: #1f2937; white-space: pre-wrap; line-height: 1.7;">${escapeHtml(structuredData.핵심_사실관계 || structuredData.facts || '-')}</div>
                        </div>
                    `;
                }
                
                // 금액 및 증거
                if (structuredData.금액_및_증거 || structuredData.amount_evidence) {
                    summaryHTML += `
                        <div style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #e5e7eb;">
                            <div style="font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">금액 및 증거</div>
                            <div style="font-size: 15px; color: #1f2937; white-space: pre-wrap; line-height: 1.7;">${escapeHtml(structuredData.금액_및_증거 || structuredData.amount_evidence || '-')}</div>
                        </div>
                    `;
                }
                
                // 특이사항
                if (structuredData.특이사항 || structuredData.notes) {
                    summaryHTML += `
                        <div style="margin-bottom: 16px;">
                            <div style="font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">특이사항</div>
                            <div style="font-size: 15px; color: #1f2937; white-space: pre-wrap; line-height: 1.7;">${escapeHtml(structuredData.특이사항 || structuredData.notes || '-')}</div>
                        </div>
                    `;
                }
                
                // 기타 필드
                Object.keys(structuredData).forEach(key => {
                    if (!['사건_유형', '핵심_사실관계', '금액_및_증거', '특이사항', 'case_type', 'facts', 'amount_evidence', 'notes'].includes(key)) {
                        const value = typeof structuredData[key] === 'object' 
                            ? JSON.stringify(structuredData[key], null, 2) 
                            : structuredData[key];
                        summaryHTML += `
                            <div style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #e5e7eb;">
                                <div style="font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">${escapeHtml(key)}</div>
                                <div style="font-size: 15px; color: #1f2937; white-space: pre-wrap; line-height: 1.7;">${escapeHtml(String(value))}</div>
                            </div>
                        `;
                    }
                });
                
                summaryHTML += '</div>';
            }
            
            // 요약 텍스트가 있으면 표시
            if (summaryText) {
                summaryHTML += `
                    <div style="background: white; border-radius: 12px; padding: 20px;">
                        <div style="font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px;">전체 요약</div>
                        <div style="font-size: 15px; color: #1f2937; white-space: pre-wrap; line-height: 1.8;">${escapeHtml(summaryText)}</div>
                    </div>
                `;
            }
            
            // 완성도 표시
            if (summaryData.completion_rate !== undefined) {
                summaryHTML += `
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 13px; color: #6b7280;">완성도:</span>
                        <div style="flex: 1; background: #e5e7eb; border-radius: 8px; height: 8px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #10b981 0%, #059669 100%); height: 100%; width: ${summaryData.completion_rate}%; transition: width 0.3s;"></div>
                        </div>
                        <span style="font-size: 13px; font-weight: 600; color: #059669;">${summaryData.completion_rate}%</span>
                    </div>
                `;
            }
            
            contentDiv.innerHTML = summaryHTML;
            summaryCard.appendChild(contentDiv);
            chatMessages.appendChild(summaryCard);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            logInfo('최종 요약 정보 표시 완료', { 
                hasSummaryText: !!summaryText,
                hasStructuredData: Object.keys(structuredData).length > 0,
                completionRate: summaryData.completion_rate
            });
        }
        
        // HTML 이스케이프 함수
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 메시지 추가
        function addMessage(type, content, isLoading = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            if (isLoading) {
                contentDiv.innerHTML = '<div class="loading"></div>';
            } else {
                contentDiv.textContent = content;
            }
            
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            return messageDiv;
        }

        // 에러 메시지 추가
        function addErrorMessage(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            chatMessages.appendChild(errorDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 상태 업데이트
        function updateStatus(text, connected) {
            statusText.textContent = text;
            if (connected) {
                statusDot.classList.remove('disconnected');
            } else {
                statusDot.classList.add('disconnected');
            }
        }

        // 모달 관련 함수들
        let selectedFiles = [];

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        function openBugReport() {
            openModal('bugReportModal');
        }

        function openDirectWrite() {
            openModal('directWriteModal');
        }

        function openFileUpload() {
            openModal('fileUploadModal');
            setupFileUpload();
        }

        function submitBugReport() {
            const description = document.getElementById('bugDescription').value;
            const steps = document.getElementById('bugSteps').value;
            const device = document.getElementById('bugDevice').value;

            if (!description.trim()) {
                alert('문제 설명을 입력해주세요.');
                return;
            }

            // 버그 신고 데이터 전송
            const bugData = {
                description: description,
                steps: steps,
                device: device,
                timestamp: new Date().toISOString(),
                user_agent: navigator.userAgent,
                url: window.location.href
            };

            // 여기서 서버로 전송하거나 로컬에 저장
            logInfo('버그 신고', bugData);
            
            // 실제로는 API 호출
            // fetch(`${API_BASE_URL}/bug/report`, { ... })

            alert('버그 신고가 접수되었습니다. 감사합니다!');
            document.getElementById('bugReportForm').reset();
            closeModal('bugReportModal');
        }

        function submitDirectWrite() {
            const content = document.getElementById('directWriteContent').value;

            if (!content.trim()) {
                alert('상담 내용을 입력해주세요.');
                return;
            }

            // 직접 작성한 내용을 채팅에 추가
            if (sessionId) {
                addMessage('user', content);
                sendDirectWrite(content);
            } else {
                alert('세션이 연결되지 않았습니다. 잠시 후 다시 시도해주세요.');
            }

            document.getElementById('directWriteForm').reset();
            closeModal('directWriteModal');
        }

        async function sendDirectWrite(content) {
            if (isProcessing || !sessionId) return;

            chatInput.disabled = true;
            sendButton.disabled = true;
            document.getElementById('fileAttachButton').disabled = true;
            isProcessing = true;
            
            const loadingMessage = addMessage('bot', '처리 중...', true);

            try {
                const response = await fetch(`${API_BASE_URL}/chat/message`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        session_id: sessionId,
                        user_message: content
                    })
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        // API 키 오류
                        localStorage.removeItem('api_key');
                        throw new Error('API 키가 유효하지 않습니다. 페이지를 새로고침하여 다시 입력해주세요.');
                    }
                    const errorData = await response.json().catch(() => ({ error: { message: `HTTP ${response.status}: ${response.statusText}` } }));
                    throw new Error(errorData.error?.message || errorData.error?.detail || `HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                loadingMessage.remove();

                if (data.success && data.data) {
                    handleBotResponse(data.data);
                } else {
                    throw new Error(data.error?.message || '메시지 전송 실패');
                }
            } catch (error) {
                logError('메시지 전송 오류', { error: error.message, stack: error.stack });
                loadingMessage.remove();
                addErrorMessage(`메시지 전송 실패: ${error.message}`);
            } finally {
                chatInput.disabled = false;
                sendButton.disabled = false;
                document.getElementById('fileAttachButton').disabled = false;
                isProcessing = false;
                chatInput.focus();
            }
        }

        function setupFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const fileUploadArea = document.getElementById('fileUploadArea');
            const fileList = document.getElementById('fileList');

            // 파일 선택 이벤트
            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });

            // 드래그 앤 드롭
            fileUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUploadArea.classList.add('dragover');
            });

            fileUploadArea.addEventListener('dragleave', () => {
                fileUploadArea.classList.remove('dragover');
            });

            fileUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUploadArea.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });
        }

        function handleFiles(files) {
            const maxSize = 10 * 1024 * 1024; // 10MB
            const allowedTypes = ['.pdf', '.jpg', '.jpeg', '.png', '.doc', '.docx', '.txt'];

            Array.from(files).forEach(file => {
                // 파일 크기 확인
                if (file.size > maxSize) {
                    alert(`파일 "${file.name}"이(가) 너무 큽니다. (최대 10MB)`);
                    return;
                }

                // 파일 타입 확인
                const fileExt = '.' + file.name.split('.').pop().toLowerCase();
                if (!allowedTypes.includes(fileExt)) {
                    alert(`지원하지 않는 파일 형식입니다: ${fileExt}`);
                    return;
                }

                // 파일 목록에 추가
                selectedFiles.push(file);
                addFileToList(file);
            });
        }

        function addFileToList(file) {
            const fileList = document.getElementById('fileList');
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <span class="file-item-name">${file.name} (${formatFileSize(file.size)})</span>
                <span class="file-item-remove" onclick="removeFile('${file.name}')">✕</span>
            `;
            fileList.appendChild(fileItem);
        }

        function removeFile(fileName) {
            selectedFiles = selectedFiles.filter(file => file.name !== fileName);
            updateFileList();
        }

        function updateFileList() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            selectedFiles.forEach(file => addFileToList(file));
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        async function submitFileUpload() {
            if (selectedFiles.length === 0) {
                alert('파일을 선택해주세요.');
                return;
            }

            if (!sessionId) {
                alert('세션이 연결되지 않았습니다. 잠시 후 다시 시도해주세요.');
                return;
            }

            const description = document.getElementById('fileDescription').value;
            const formData = new FormData();
            
            // 파일 추가
            selectedFiles.forEach((file) => {
                formData.append('files', file);
            });
            
            formData.append('session_id', sessionId);
            if (description) {
                formData.append('description', description);
            }

            // UI 비활성화
            const submitButton = document.querySelector('#fileUploadModal .btn-primary');
            const originalText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.textContent = '업로드 중...';

            try {
                // 파일 업로드 API 호출
                const headers = {};
                if (API_KEY) {
                    headers['Authorization'] = `Bearer ${API_KEY}`;
                }
                const response = await fetch(`${API_BASE_URL}/chat/upload`, {
                    method: 'POST',
                    headers: headers,
                    body: formData
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        // API 키 오류
                        localStorage.removeItem('api_key');
                        throw new Error('API 키가 유효하지 않습니다. 페이지를 새로고침하여 다시 입력해주세요.');
                    }
                    const errorData = await response.json().catch(() => ({ error: { message: `HTTP ${response.status}: ${response.statusText}` } }));
                    throw new Error(errorData.error?.message || errorData.error?.detail || `HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();

                if (data.success && data.data) {
                    const fileNames = selectedFiles.map(f => f.name).join(', ');
                    const uploadMessage = `[파일 첨부] ${fileNames}${description ? '\n' + description : ''}`;
                    
                    // 채팅에 파일 첨부 메시지 추가
                    addMessage('user', uploadMessage);
                    
                    alert(`${data.data.uploaded_count}개의 파일이 성공적으로 업로드되었습니다.`);
                } else {
                    throw new Error(data.error?.message || '파일 업로드 실패');
                }
            } catch (error) {
                logError('파일 업로드 오류', { error: error.message, stack: error.stack });
                alert(`파일 업로드 실패: ${error.message}`);
            } finally {
                // UI 활성화
                submitButton.disabled = false;
                submitButton.textContent = originalText;
                
                // 초기화
                selectedFiles = [];
                document.getElementById('fileUploadForm').reset();
                updateFileList();
                closeModal('fileUploadModal');
            }
        }

        // 모달 외부 클릭 시 닫기
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                e.target.classList.remove('active');
                document.body.style.overflow = '';
            }
        });

        // ESC 키로 모달 닫기
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const activeModal = document.querySelector('.modal-overlay.active');
                if (activeModal) {
                    activeModal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            }
        });

        // 이벤트 리스너
        sendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // 초기화
        startSession();
    </script>

    <!-- 디버그 패널 -->
    <div class="debug-panel" id="debugPanel">
        <div class="debug-panel-header">
            <div class="debug-panel-title">🔍 디버그 로그</div>
            <div class="debug-panel-controls">
                <button class="debug-panel-btn" onclick="clearDebugLogs()">지우기</button>
                <button class="debug-panel-btn" onclick="toggleDebugPanel()">닫기</button>
            </div>
        </div>
        <div class="debug-panel-content" id="debugLogContent">
            <!-- 로그 항목들이 여기에 추가됩니다 -->
        </div>
    </div>

    <script>
        // 디버그 로깅 시스템
        const DEBUG_ENABLED = true; // 항상 활성화
        const MAX_DEBUG_LOGS = 100; // 최대 로그 개수

        function debugLog(level, message, data = null) {
            const timestamp = new Date().toLocaleTimeString('ko-KR');
            const logEntry = {
                level,
                timestamp,
                message,
                data
            };

            // 콘솔 로그
            const consoleMethod = {
                'log': console.log,
                'info': console.info,
                'warn': console.warn,
                'error': console.error
            }[level] || console.log;

            if (data) {
                consoleMethod(`[${timestamp}] ${message}`, data);
            } else {
                consoleMethod(`[${timestamp}] ${message}`);
            }

            // HTML 디버그 패널에 추가
            if (DEBUG_ENABLED) {
                addDebugLogToPanel(logEntry);
            }
        }

        function addDebugLogToPanel(logEntry) {
            const panel = document.getElementById('debugPanel');
            const content = document.getElementById('debugLogContent');
            
            if (!panel || !content) return;

            // 최대 로그 개수 제한
            const logs = content.children;
            if (logs.length >= MAX_DEBUG_LOGS) {
                content.removeChild(logs[0]);
            }

            const logDiv = document.createElement('div');
            logDiv.className = `debug-log-entry ${logEntry.level}`;
            
            const timeDiv = document.createElement('div');
            timeDiv.className = 'debug-log-time';
            timeDiv.textContent = logEntry.timestamp;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'debug-log-message';
            messageDiv.textContent = logEntry.message;
            
            logDiv.appendChild(timeDiv);
            logDiv.appendChild(messageDiv);

            if (logEntry.data) {
                const dataDiv = document.createElement('div');
                dataDiv.className = 'debug-log-data';
                dataDiv.textContent = JSON.stringify(logEntry.data, null, 2);
                logDiv.appendChild(dataDiv);
            }

            content.appendChild(logDiv);
            
            // 자동 스크롤
            content.scrollTop = content.scrollHeight;
        }

        function toggleDebugPanel() {
            const panel = document.getElementById('debugPanel');
            if (panel) {
                panel.classList.toggle('visible');
            }
        }

        function clearDebugLogs() {
            const content = document.getElementById('debugLogContent');
            if (content) {
                content.innerHTML = '';
                debugLog('info', '디버그 로그가 지워졌습니다.');
            }
        }

        // 로깅 헬퍼 함수들
        function logInfo(message, data = null) {
            debugLog('info', message, data);
        }

        function logWarn(message, data = null) {
            debugLog('warn', message, data);
        }

        function logError(message, data = null) {
            debugLog('error', message, data);
        }

        function logApiRequest(method, url, body = null) {
            logInfo(`API 요청: ${method} ${url}`, { body });
        }

        function logApiResponse(method, url, response, data = null) {
            logInfo(`API 응답: ${method} ${url}`, { 
                status: response.status, 
                statusText: response.statusText,
                data 
            });
        }

        function logStateTransition(fromState, toState, sessionId) {
            logInfo(`State 전이: ${fromState} → ${toState}`, { sessionId });
        }
