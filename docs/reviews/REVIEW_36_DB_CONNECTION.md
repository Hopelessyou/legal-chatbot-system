# DB Connection ê²€í†  ë³´ê³ ì„œ

## ê²€í†  ëŒ€ìƒ
- íŒŒì¼: `src/db/connection.py`
- ê²€í†  ì¼ì: 2024ë…„
- ê²€í†  ë²”ìœ„: DB ì—°ê²° ê´€ë¦¬, ì„¸ì…˜ íŒ©í† ë¦¬, í—¬ìŠ¤ì²´í¬, ì—°ê²° í’€ ì„¤ì •

---

## âœ… ì •ìƒ ë™ì‘ ë¶€ë¶„

### 1. í´ë˜ìŠ¤ êµ¬ì¡° (Lines 15-21)
- âœ… `DatabaseManager` í´ë˜ìŠ¤ êµ¬ì¡° ëª…í™•
- âœ… ì‹±ê¸€í†¤ íŒ¨í„´ ì‚¬ìš© (ì „ì—­ ì¸ìŠ¤í„´ìŠ¤)

### 2. ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì´ˆê¸°í™” (Lines 23-46)
- âœ… `_initialize()`: ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì´ˆê¸°í™” ë¡œì§ ì ì ˆ
- âœ… ì—°ê²° í’€ ì„¤ì • (`QueuePool`, `pool_size=5`, `max_overflow=10`)
- âœ… `pool_pre_ping=True`: ì—°ê²° ìœ íš¨ì„± ì‚¬ì „ í™•ì¸
- âœ… `scoped_session` ì‚¬ìš©ìœ¼ë¡œ ìŠ¤ë ˆë“œ ì•ˆì „ì„± í™•ë³´
- âœ… ì—ëŸ¬ ì²˜ë¦¬ ë° ë¡œê¹… êµ¬í˜„ë¨

### 3. ì„¸ì…˜ íšë“ (Lines 48-55, 57-79)
- âœ… `get_session()`: ì„¸ì…˜ íšë“ ë¡œì§ ê°„ë‹¨í•˜ê³  ëª…í™•
- âœ… `get_db_session()`: ì»¨í…ìŠ¤íŠ¸ ë§¤ë‹ˆì €ë¡œ ì„¸ì…˜ ê´€ë¦¬
- âœ… ìë™ ì»¤ë°‹/ë¡¤ë°± ì²˜ë¦¬
- âœ… ì„¸ì…˜ ì¢…ë£Œ ë³´ì¥ (`finally` ë¸”ë¡)

### 4. í—¬ìŠ¤ì²´í¬ (Lines 81-95)
- âœ… `health_check()`: ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ìƒíƒœ í™•ì¸ ë¡œì§ ì ì ˆ
- âœ… ê°„ë‹¨í•œ ì¿¼ë¦¬ ì‹¤í–‰ìœ¼ë¡œ ì—°ê²° í™•ì¸
- âœ… ì—ëŸ¬ ì²˜ë¦¬ ë° ë¡œê¹… êµ¬í˜„ë¨

### 5. ì—°ê²° ì¢…ë£Œ (Lines 97-101)
- âœ… `close()`: ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì¢…ë£Œ ë¡œì§ ì ì ˆ
- âœ… `engine.dispose()`ë¡œ ì—°ê²° í’€ ì •ë¦¬

### 6. FastAPI ì˜ì¡´ì„± ì£¼ì… (Lines 108-119)
- âœ… `get_db()`: FastAPI ì˜ì¡´ì„± ì£¼ì…ìš© í•¨ìˆ˜ êµ¬í˜„
- âœ… ì œë„ˆë ˆì´í„° íŒ¨í„´ ì‚¬ìš©

---

## âš ï¸ ë°œê²¬ëœ ë¬¸ì œì 

### 1. ğŸŸ¡ **ì¤‘ìš”í•œ ë¬¸ì œ**: `get_db_session`ì—ì„œ ì˜ˆì™¸ ë°œìƒ ì‹œ í•­ìƒ ë¡¤ë°± (Line 75)

**ë¬¸ì œ**: ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ í•­ìƒ `rollback()`ì„ í˜¸ì¶œí•˜ì§€ë§Œ, ì´ë¯¸ ì»¤ë°‹ëœ íŠ¸ëœì­ì…˜ì´ë‚˜ ì½ê¸° ì „ìš© ì‘ì—…ì—ì„œëŠ” ë¶ˆí•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜í•œ ì¼ë¶€ ì˜ˆì™¸(ì˜ˆ: `IntegrityError`)ëŠ” ë¡¤ë°± í›„ì—ë„ ì¬ì‹œë„ê°€ ì–´ë ¤ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```python
except Exception as e:
    session.rollback()  # âŒ í•­ìƒ ë¡¤ë°±
    logger.error(f"ë°ì´í„°ë² ì´ìŠ¤ ì„¸ì…˜ ì˜¤ë¥˜: {str(e)}")
    raise
```

**ì˜í–¥ë„**: ë‚®ìŒ-ì¤‘ê°„  
**ìˆ˜ì • ê¶Œì¥**: ì˜ˆì™¸ íƒ€ì…ì— ë”°ë¥¸ ì²˜ë¦¬ ë˜ëŠ” ë” êµ¬ì²´ì ì¸ ì˜ˆì™¸ ì²˜ë¦¬

**ìˆ˜ì • ì˜ˆì‹œ**:
```python
except Exception as e:
    try:
        session.rollback()
    except Exception as rollback_error:
        logger.error(f"ë¡¤ë°± ì‹¤íŒ¨: {str(rollback_error)}")
    logger.error(f"ë°ì´í„°ë² ì´ìŠ¤ ì„¸ì…˜ ì˜¤ë¥˜: {str(e)}", exc_info=True)
    raise
```

---

### 2. ğŸŸ¡ **ì¤‘ìš”í•œ ë¬¸ì œ**: `get_db_session`ì—ì„œ ì„±ê³µ ì‹œ í•­ìƒ ì»¤ë°‹ (Line 73)

**ë¬¸ì œ**: ì˜ˆì™¸ê°€ ë°œìƒí•˜ì§€ ì•Šìœ¼ë©´ í•­ìƒ `commit()`ì„ í˜¸ì¶œí•©ë‹ˆë‹¤. í•˜ì§€ë§Œ ì½ê¸° ì „ìš© ì‘ì—…ì´ë‚˜ ëª…ì‹œì ìœ¼ë¡œ ì»¤ë°‹í•˜ì§€ ì•Šì•„ì•¼ í•˜ëŠ” ê²½ìš°ì—ëŠ” ë¶ˆí•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```python
try:
    yield session
    session.commit()  # âŒ í•­ìƒ ì»¤ë°‹
except Exception as e:
    ...
```

**ì˜í–¥ë„**: ë‚®ìŒ  
**ìˆ˜ì • ê¶Œì¥**: ì½ê¸° ì „ìš© ì‘ì—… êµ¬ë¶„ ë˜ëŠ” ì„ íƒì  ì»¤ë°‹

**ì°¸ê³ **: í˜„ì¬ êµ¬í˜„ì€ ì¼ë°˜ì ì¸ íŒ¨í„´ì´ë¯€ë¡œ í° ë¬¸ì œëŠ” ì•„ë‹™ë‹ˆë‹¤. í•„ìš”ì‹œ ê°œì„  ê°€ëŠ¥.

---

### 3. ğŸŸ¢ **ë‚®ìŒ**: `get_db`ì—ì„œ ì»¤ë°‹/ë¡¤ë°± ì²˜ë¦¬ ì—†ìŒ (Lines 108-119)

**ë¬¸ì œ**: `get_db()` í•¨ìˆ˜ëŠ” ì„¸ì…˜ë§Œ ì œê³µí•˜ê³  ì»¤ë°‹/ë¡¤ë°±ì„ ì²˜ë¦¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. FastAPI ë¼ìš°í„°ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì²˜ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤.

**ì˜í–¥ë„**: ë‚®ìŒ  
**ìˆ˜ì • ê¶Œì¥**: ë¬¸ì„œí™” ë˜ëŠ” `get_db_session` ì‚¬ìš© ê¶Œì¥

**ì°¸ê³ **: FastAPIì˜ ì¼ë°˜ì ì¸ íŒ¨í„´ì´ë¯€ë¡œ í° ë¬¸ì œëŠ” ì•„ë‹™ë‹ˆë‹¤. ë‹¤ë§Œ ì¼ê´€ì„±ì„ ìœ„í•´ `get_db_session` ì‚¬ìš©ì„ ê¶Œì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

### 4. ğŸŸ¢ **ë‚®ìŒ**: ì—°ê²° í’€ ì„¤ì •ì´ í•˜ë“œì½”ë”©ë¨ (Lines 29-30)

**ë¬¸ì œ**: `pool_size=5`, `max_overflow=10`ì´ í•˜ë“œì½”ë”©ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì„¤ì • íŒŒì¼ì—ì„œ ê´€ë¦¬í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.

**ì˜í–¥ë„**: ë‚®ìŒ  
**ìˆ˜ì • ê¶Œì¥**: ì„¤ì • íŒŒì¼ë¡œ ì´ë™

**ìˆ˜ì • ì˜ˆì‹œ**:
```python
self.engine = create_engine(
    settings.database_url,
    poolclass=QueuePool,
    pool_size=getattr(settings, 'db_pool_size', 5),
    max_overflow=getattr(settings, 'db_max_overflow', 10),
    pool_pre_ping=True,
    echo=False,
)
```

---

### 5. ğŸŸ¢ **ë‚®ìŒ**: `health_check`ì—ì„œ ì—°ê²° í•´ì œ ì—†ìŒ (Line 89)

**ë¬¸ì œ**: `with self.engine.connect() as conn:`ì„ ì‚¬ìš©í•˜ì§€ë§Œ, ì—°ê²°ì´ ì œëŒ€ë¡œ í•´ì œë˜ëŠ”ì§€ í™•ì¸ í•„ìš”í•©ë‹ˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œëŠ” ë¬¸ì œì—†ì§€ë§Œ, ëª…ì‹œì ìœ¼ë¡œ í™•ì¸í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.

**ì˜í–¥ë„**: ë‚®ìŒ  
**ìˆ˜ì • ê¶Œì¥**: í˜„ì¬ êµ¬í˜„ì´ ì ì ˆí•˜ë¯€ë¡œ ë³€ê²½ ë¶ˆí•„ìš”

---

### 6. ğŸŸ¢ **ë‚®ìŒ**: `scoped_session` ì‚¬ìš© ì‹œ ìŠ¤ë ˆë“œ ë¡œì»¬ ì„¸ì…˜ ê´€ë¦¬

**ë¬¸ì œ**: `scoped_session`ì€ ìŠ¤ë ˆë“œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. FastAPIëŠ” ë¹„ë™ê¸°ì´ë¯€ë¡œ ìŠ¤ë ˆë“œ ì•ˆì „ì„±ì€ ì¤‘ìš”í•˜ì§€ë§Œ, ë¹„ë™ê¸° ì»¨í…ìŠ¤íŠ¸ì—ì„œëŠ” ì¶”ê°€ ê³ ë ¤ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ì˜í–¥ë„**: ë‚®ìŒ  
**ìˆ˜ì • ê¶Œì¥**: í˜„ì¬ êµ¬í˜„ì´ ì ì ˆí•˜ë¯€ë¡œ ë³€ê²½ ë¶ˆí•„ìš”

---

### 7. ğŸŸ¢ **ë‚®ìŒ**: ì—°ê²° í’€ íƒ€ì„ì•„ì›ƒ ì„¤ì • ì—†ìŒ

**ë¬¸ì œ**: ì—°ê²° í’€ íƒ€ì„ì•„ì›ƒ(`pool_timeout`)ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’ì„ ì‚¬ìš©í•˜ì§€ë§Œ, ëª…ì‹œì ìœ¼ë¡œ ì„¤ì •í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.

**ì˜í–¥ë„**: ë‚®ìŒ  
**ìˆ˜ì • ê¶Œì¥**: íƒ€ì„ì•„ì›ƒ ì„¤ì • ì¶”ê°€

**ìˆ˜ì • ì˜ˆì‹œ**:
```python
self.engine = create_engine(
    settings.database_url,
    poolclass=QueuePool,
    pool_size=5,
    max_overflow=10,
    pool_pre_ping=True,
    pool_timeout=30,  # ì—°ê²° í’€ì—ì„œ ì—°ê²°ì„ ê¸°ë‹¤ë¦¬ëŠ” ìµœëŒ€ ì‹œê°„ (ì´ˆ)
    echo=False,
)
```

---

### 8. ğŸŸ¢ **ë‚®ìŒ**: `close()`ì—ì„œ `SessionLocal` ì •ë¦¬ ì—†ìŒ

**ë¬¸ì œ**: `close()`ì—ì„œ `engine.dispose()`ë§Œ í˜¸ì¶œí•˜ê³  `SessionLocal`ì€ ì •ë¦¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. `scoped_session.remove()`ë¥¼ í˜¸ì¶œí•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.

**ì˜í–¥ë„**: ë‚®ìŒ  
**ìˆ˜ì • ê¶Œì¥**: `SessionLocal.remove()` í˜¸ì¶œ ì¶”ê°€

**ìˆ˜ì • ì˜ˆì‹œ**:
```python
def close(self):
    """ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì¢…ë£Œ"""
    if self.engine:
        if self.SessionLocal:
            self.SessionLocal.remove()  # ìŠ¤ë ˆë“œ ë¡œì»¬ ì„¸ì…˜ ì •ë¦¬
        self.engine.dispose()
        logger.info("ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì¢…ë£Œ")
```

---

## ğŸ“Š ê²€í†  ìš”ì•½

### ë°œê²¬ëœ ë¬¸ì œ
- ğŸŸ¡ **ì¤‘ìš”í•œ ë¬¸ì œ**: 2ê°œ (ì˜ˆì™¸ ì²˜ë¦¬, í•­ìƒ ì»¤ë°‹)
- ğŸŸ¢ **ë‚®ìŒ**: 6ê°œ (ì»¤ë°‹/ë¡¤ë°± ì²˜ë¦¬, í•˜ë“œì½”ë”©, íƒ€ì„ì•„ì›ƒ, ì„¸ì…˜ ì •ë¦¬ ë“±)

### ìš°ì„ ìˆœìœ„ë³„ ìˆ˜ì • ê¶Œì¥
1. ğŸŸ¡ **ì¤‘ìš”**: `get_db_session`ì—ì„œ ì˜ˆì™¸ ì²˜ë¦¬ ê°œì„  (ë¡¤ë°± ì‹¤íŒ¨ ì²˜ë¦¬)
2. ğŸŸ¢ **ë‚®ìŒ**: ì—°ê²° í’€ íƒ€ì„ì•„ì›ƒ ì„¤ì • ì¶”ê°€, `close()`ì—ì„œ ì„¸ì…˜ ì •ë¦¬ ì¶”ê°€

---

## ğŸ”§ ìˆ˜ì • ì œì•ˆ

### ìˆ˜ì • 1: ì˜ˆì™¸ ì²˜ë¦¬ ê°œì„ 

```python
@contextmanager
def get_db_session(self) -> Generator[Session, None, None]:
    """
    ì»¨í…ìŠ¤íŠ¸ ë§¤ë‹ˆì €ë¥¼ ì‚¬ìš©í•œ ë°ì´í„°ë² ì´ìŠ¤ ì„¸ì…˜ íšë“
    
    Yields:
        Session ì¸ìŠ¤í„´ìŠ¤
    
    Example:
        with db_manager.get_db_session() as session:
            # DB ì‘ì—… ìˆ˜í–‰
            pass
    """
    session = self.get_session()
    try:
        yield session
        session.commit()
    except Exception as e:
        try:
            session.rollback()
        except Exception as rollback_error:
            logger.error(f"ë¡¤ë°± ì‹¤íŒ¨: {str(rollback_error)}")
        logger.error(f"ë°ì´í„°ë² ì´ìŠ¤ ì„¸ì…˜ ì˜¤ë¥˜: {str(e)}", exc_info=True)
        raise
    finally:
        session.close()
```

### ìˆ˜ì • 2: ì—°ê²° í’€ íƒ€ì„ì•„ì›ƒ ì„¤ì • ì¶”ê°€

```python
self.engine = create_engine(
    settings.database_url,
    poolclass=QueuePool,
    pool_size=5,
    max_overflow=10,
    pool_pre_ping=True,
    pool_timeout=30,  # ì—°ê²° í’€ì—ì„œ ì—°ê²°ì„ ê¸°ë‹¤ë¦¬ëŠ” ìµœëŒ€ ì‹œê°„ (ì´ˆ)
    echo=False,
)
```

### ìˆ˜ì • 3: close()ì—ì„œ ì„¸ì…˜ ì •ë¦¬ ì¶”ê°€

```python
def close(self):
    """ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì¢…ë£Œ"""
    if self.engine:
        if self.SessionLocal:
            try:
                self.SessionLocal.remove()  # ìŠ¤ë ˆë“œ ë¡œì»¬ ì„¸ì…˜ ì •ë¦¬
            except Exception as e:
                logger.warning(f"ì„¸ì…˜ ì •ë¦¬ ì‹¤íŒ¨: {str(e)}")
        self.engine.dispose()
        logger.info("ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì¢…ë£Œ")
```

---

## âœ… ê²°ë¡ 

`DatabaseManager` í´ë˜ìŠ¤ëŠ” ì „ë°˜ì ìœ¼ë¡œ ì˜ êµ¬í˜„ë˜ì–´ ìˆìœ¼ë‚˜, **ì˜ˆì™¸ ì²˜ë¦¬ ê°œì„ **ê³¼ **ì—°ê²° í’€ íƒ€ì„ì•„ì›ƒ ì„¤ì •** ì¶”ê°€ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤. ë˜í•œ `close()`ì—ì„œ ì„¸ì…˜ ì •ë¦¬ë¥¼ ì¶”ê°€í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.

**ìš°ì„ ìˆœìœ„**:
1. ğŸŸ¡ **ì¤‘ìš”**: `get_db_session`ì—ì„œ ì˜ˆì™¸ ì²˜ë¦¬ ê°œì„  (ë¡¤ë°± ì‹¤íŒ¨ ì²˜ë¦¬)
2. ğŸŸ¢ **ë‚®ìŒ**: ì—°ê²° í’€ íƒ€ì„ì•„ì›ƒ ì„¤ì • ì¶”ê°€, `close()`ì—ì„œ ì„¸ì…˜ ì •ë¦¬ ì¶”ê°€

